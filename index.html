<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Sunburst Generator (SVG)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom Scrollbar for desktop sidebar */
        @media (min-width: 768px) {
            aside::-webkit-scrollbar, #gradient-stops-container::-webkit-scrollbar {
                width: 8px;
            }
            aside::-webkit-scrollbar-track, #gradient-stops-container::-webkit-scrollbar-track {
                background: #1f2937;
            }
            aside::-webkit-scrollbar-thumb, #gradient-stops-container::-webkit-scrollbar-thumb {
                background: #4b5563;
                border-radius: 4px;
            }
            aside::-webkit-scrollbar-thumb:hover, #gradient-stops-container::-webkit-scrollbar-thumb:hover {
                background: #6b7280;
            }
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #374151;
            border-radius: 3px;
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #6366f1;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #6366f1;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
        }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-width: 40px;
            height: 40px;
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch {
            border-radius: 50%;
            border: 2px solid #4b5563;
        }
        input[type="color"]::-moz-color-swatch {
            border-radius: 50%;
            border: 2px solid #4b5563;
        }
        .color-input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .color-input-wrapper label {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            color: #9ca3af;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .bg-grid-pattern {
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col md:flex-row md:h-screen md:overflow-hidden">

    <!-- SVG Area (Order 1 on mobile, 2 on desktop) -->
    <main class="flex-1 flex items-center justify-center p-8 relative bg-grid-pattern h-[60vh] md:h-auto md:order-2 overflow-auto">
        <svg id="sunburst-svg" class="rounded-lg shadow-2xl max-w-full max-h-full"></svg>
    </main>
    
    <!-- Controls Sidebar (Order 2 on mobile, 1 on desktop) -->
    <aside class="w-full md:w-80 lg:w-96 bg-gray-800/50 backdrop-blur-sm p-4 md:p-6 space-y-6 md:overflow-y-auto border-t md:border-t-0 md:border-r border-gray-700 md:order-1">
        <div class="flex items-center space-x-3">
             <svg class="w-8 h-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
            </svg>
            <h1 class="text-2xl font-bold text-white">Sunburst Generator</h1>
        </div>

        <!-- Canvas Size -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-lg font-semibold text-indigo-400">Canvas</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="canvas-width" class="text-sm font-medium mb-1 block">Width (px)</label>
                    <input type="number" id="canvas-width" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="canvas-height" class="text-sm font-medium mb-1 block">Height (px)</label>
                    <input type="number" id="canvas-height" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </div>

        <!-- Basic Settings -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-lg font-semibold text-indigo-400">Settings</h2>
            <div>
                <label for="rays" class="flex justify-between text-sm font-medium mb-1">Rays <span id="rays-value" class="text-indigo-400 font-semibold">16</span></label>
                <input type="range" id="rays" min="2" max="100" step="2">
            </div>
            <div>
                <label for="centerX" class="flex justify-between text-sm font-medium mb-1">Center X <span id="centerX-value" class="text-indigo-400 font-semibold">50%</span></label>
                <input type="range" id="centerX" min="0" max="100">
            </div>
            <div>
                <label for="centerY" class="flex justify-between text-sm font-medium mb-1">Center Y <span id="centerY-value" class="text-indigo-400 font-semibold">50%</span></label>
                <input type="range" id="centerY" min="0" max="100">
            </div>
        </div>

        <!-- Color & Gradient -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-lg font-semibold text-indigo-400">Fill Style</h2>
            <div id="gradient-type" class="grid grid-cols-3 gap-2">
                <button data-type="solid" class="gradient-btn px-3 py-2 rounded-md text-sm font-medium">Solid</button>
                <button data-type="linear" class="gradient-btn px-3 py-2 rounded-md text-sm font-medium">Linear</button>
                <button data-type="radial" class="gradient-btn px-3 py-2 rounded-md text-sm font-medium">Radial</button>
            </div>
            
            <div id="solid-colors-container" class="flex items-center justify-around gap-3 pt-4">
                 <div class="color-input-wrapper">
                    <label for="solid-color1">Color 1</label>
                    <input type="color" id="solid-color1">
                </div>
                <div class="color-input-wrapper">
                    <label for="solid-color2">Color 2 (Background)</label>
                    <input type="color" id="solid-color2">
                </div>
            </div>

            <div id="linear-gradient-editor" class="hidden space-y-4 pt-4">
                 <div class="flex items-center justify-around gap-3">
                   <div class="color-input-wrapper">
                      <label for="gradient-color1">Start Color</label>
                      <input type="color" id="gradient-color1">
                  </div>
                  <div class="color-input-wrapper">
                      <label for="gradient-color2">End Color</label>
                      <input type="color" id="gradient-color2">
                  </div>
                </div>
                <div id="gradient-angle-container">
                    <label for="gradient-angle" class="flex justify-between text-sm font-medium mb-1">Linear Angle <span id="gradient-angle-value" class="text-indigo-400 font-semibold">0Â°</span></label>
                    <input type="range" id="gradient-angle" min="0" max="360" value="0">
                </div>
            </div>

            <div id="radial-gradient-editor" class="hidden space-y-4 pt-4">
                <h3 class="text-md font-semibold text-gray-300 pt-2 border-b border-gray-700 pb-2">Color Stops</h3>
                <div id="gradient-stops-container" class="space-y-3 max-h-48 overflow-y-auto pr-2">
                    <!-- JS will populate this -->
                </div>
                <button id="add-stop-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center gap-2 transition-colors text-sm">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                    Add Color Stop
                </button>
            </div>
        </div>

        <!-- Warp Effect -->
        <div class="space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-lg font-semibold text-indigo-400">Warp Effect</h2>
            <div>
                <label for="warp-type" class="text-sm font-medium mb-1 block">Type</label>
                <select id="warp-type" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="none">None</option>
                    <option value="twist">Twist</option>
                </select>
            </div>
             <div id="warp-strength-container">
                 <label for="warp-strength" id="warp-strength-label" class="flex justify-between text-sm font-medium mb-1">Bend <span id="warp-strength-value" class="text-indigo-400 font-semibold">65%</span></label>
                <input type="range" id="warp-strength" min="-100" max="100" step="1">
            </div>
            <div id="twist-distortion-container" class="hidden space-y-4">
                 <div>
                    <label for="horizontal-distortion" class="flex justify-between text-sm font-medium mb-1">Horizontal <span id="horizontal-distortion-value" class="text-indigo-400 font-semibold">0%</span></label>
                    <input type="range" id="horizontal-distortion" min="-100" max="100" value="0" step="1">
                </div>
                 <div>
                    <label for="vertical-distortion" class="flex justify-between text-sm font-medium mb-1">Vertical <span id="vertical-distortion-value" class="text-indigo-400 font-semibold">0%</span></label>
                    <input type="range" id="vertical-distortion" min="-100" max="100" value="0" step="1">
                </div>
            </div>
        </div>

        <!-- Actions -->
         <div class="space-y-4 pt-4 border-t border-gray-700">
             <h2 class="text-lg font-semibold text-indigo-400">Actions</h2>
             <div class="space-y-3">
                 <button id="randomize-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.69a8.25 8.25 0 0 0-11.667 0l-3.181 3.183" /></svg>
                    Randomize
                </button>
                 <button id="copy-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" /></svg>
                    Copy SVG Code
                </button>
                <button id="download-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Download SVG
                </button>
             </div>
         </div>
    </aside>

    <script>
        // --- DOM Elements ---
        const svg = document.getElementById('sunburst-svg');
        const canvasWidthInput = document.getElementById('canvas-width');
        const canvasHeightInput = document.getElementById('canvas-height');
        const raysSlider = document.getElementById('rays');
        const raysValue = document.getElementById('rays-value');
        const centerXSlider = document.getElementById('centerX');
        const centerXValue = document.getElementById('centerX-value');
        const centerYSlider = document.getElementById('centerY');
        const centerYValue = document.getElementById('centerY-value');
        const solidColor1Input = document.getElementById('solid-color1');
        const solidColor2Input = document.getElementById('solid-color2');
        const solidColorsContainer = document.getElementById('solid-colors-container');
        const gradientTypeContainer = document.getElementById('gradient-type');
        const linearGradientEditor = document.getElementById('linear-gradient-editor');
        const gradientColor1Input = document.getElementById('gradient-color1');
        const gradientColor2Input = document.getElementById('gradient-color2');
        const gradientAngleSlider = document.getElementById('gradient-angle');
        const gradientAngleValue = document.getElementById('gradient-angle-value');
        const radialGradientEditor = document.getElementById('radial-gradient-editor');
        const gradientStopsContainer = document.getElementById('gradient-stops-container');
        const addStopBtn = document.getElementById('add-stop-btn');
        const warpTypeSelect = document.getElementById('warp-type');
        const warpStrengthContainer = document.getElementById('warp-strength-container');
        const warpStrengthLabel = document.getElementById('warp-strength-label');
        const warpStrengthSlider = document.getElementById('warp-strength');
        const warpStrengthValue = document.getElementById('warp-strength-value');
        const twistDistortionContainer = document.getElementById('twist-distortion-container');
        const horizontalDistortionSlider = document.getElementById('horizontal-distortion');
        const horizontalDistortionValue = document.getElementById('horizontal-distortion-value');
        const verticalDistortionSlider = document.getElementById('vertical-distortion');
        const verticalDistortionValue = document.getElementById('vertical-distortion-value');
        const downloadBtn = document.getElementById('download-btn');
        const copyBtn = document.getElementById('copy-btn');
        const randomizeBtn = document.getElementById('randomize-btn');

        // --- Application State ---
        let state = {
            rays: 36, centerX: 50, centerY: 50,
            solidColors: ['#FDE047', '#F97316'],
            gradientColors: ['#FDE047', '#F97316'], // For Linear
            radialGradient: {
                stops: [ { color: '#FDE047', offset: 0 }, { color: '#F97316', offset: 100 } ]
            },
            gradientType: 'solid', gradientAngle: 0,
            warpType: 'twist', warpStrength: 65,
            horizontalDistortion: 0, verticalDistortion: 0,
            canvasWidth: 1000, canvasHeight: 1000,
        };
        
        let debounceTimer;

        // --- Core Drawing Logic ---
        function drawSunburst() {
            const { rays, centerX, centerY, solidColors, gradientColors, gradientType, gradientAngle, warpType, warpStrength, horizontalDistortion, verticalDistortion, canvasWidth, canvasHeight, radialGradient } = state;
            const cx = canvasWidth * (centerX / 100);
            const cy = canvasHeight * (centerY / 100);
            let defs = '';

            // Helper function to round numbers to prevent vector artifacts
            const round = (n) => Math.round(n * 1000) / 1000;
            
            // Define a clipping path that matches the canvas size. This is the fix.
            defs += `<clipPath id="canvas-clip"><rect x="0" y="0" width="${canvasWidth}" height="${canvasHeight}" /></clipPath>`;

            // Ray gradient definition
            if (gradientType === 'linear' || gradientType === 'radial') {
                const gradId = "sunburstGradient";
                if (gradientType === 'linear') {
                    const angleRad = (gradientAngle - 90) * (Math.PI / 180);
                    const r = Math.sqrt(canvasWidth**2 + canvasHeight**2) / 2;
                    const x1 = cx + Math.cos(angleRad) * r; const y1 = cy + Math.sin(angleRad) * r;
                    const x2 = cx - Math.cos(angleRad) * r; const y2 = cy - Math.sin(angleRad) * r;
                    let stopsHtml = `<stop offset="0%" stop-color="${gradientColors[0]}" /><stop offset="100%" stop-color="${gradientColors[1]}" />`;
                    defs += `<linearGradient id="${gradId}" x1="${round(x2)}" y1="${round(y2)}" x2="${round(x1)}" y2="${round(y1)}" gradientUnits="userSpaceOnUse">${stopsHtml}</linearGradient>`;
                } else { // Radial
                    const r = Math.sqrt(canvasWidth**2 + canvasHeight**2) / 2;
                    let stopsHtml = radialGradient.stops.map(stop => `<stop offset="${stop.offset}%" stop-color="${stop.color}" />`).join('');
                    defs += `<radialGradient id="${gradId}" cx="${round(cx)}" cy="${round(cy)}" r="${round(r)}" gradientUnits="userSpaceOnUse">${stopsHtml}</radialGradient>`;
                }
            }
            
            let innerContent = '';
            const radius = Math.sqrt(canvasWidth**2 + canvasHeight**2) * 1.5; 

            if (rays > 0) {
                const angleStep = 360 / rays;
                function createRayPath(i) {
                    const startAngleRad = ((i * angleStep) - 90) * Math.PI / 180;
                    const endAngleRad = (((i + 1) * angleStep) - 90) * Math.PI / 180; 
                    if (warpType === 'twist' && warpStrength !== 0) {
                        const bend = warpStrength * (Math.PI / 180); 
                        const distort = (x, y) => {
                            const dx = x - cx; const dy = y - cy;
                            const r = Math.sqrt(dx*dx + dy*dy);
                            const angle = Math.atan2(dy, dx);
                            const newAngle = angle + (r / radius) * bend;
                            let newX = cx + r * Math.cos(newAngle) + (horizontalDistortion / 100) * (y-cy);
                            let newY = cy + r * Math.sin(newAngle) + (verticalDistortion / 100) * (x-cx);
                            return [newX, newY];
                        };
                        const [p1x, p1y] = distort(cx + radius * Math.cos(startAngleRad), cy + radius * Math.sin(startAngleRad));
                        const [p2x, p2y] = distort(cx + radius * Math.cos(endAngleRad), cy + radius * Math.sin(endAngleRad));
                        const [cp1x, cp1y] = distort(cx + radius/2 * Math.cos(startAngleRad), cy + radius/2 * Math.sin(startAngleRad));
                        const [cp2x, cp2y] = distort(cx + radius/2 * Math.cos(endAngleRad), cy + radius/2 * Math.sin(endAngleRad));
                        return `M${round(cx)},${round(cy)} Q ${round(cp1x)},${round(cp1y)} ${round(p1x)},${round(p1y)} L ${round(p2x)},${round(p2y)} Q ${round(cp2x)},${round(cp2y)} ${round(cx)},${round(cy)} Z`;
                    } else {
                         const x1 = cx + radius * Math.cos(startAngleRad); const y1 = cy + radius * Math.sin(startAngleRad);
                         const x2 = cx + radius * Math.cos(endAngleRad); const y2 = cy + radius * Math.sin(endAngleRad);
                         return `M${round(cx)},${round(cy)} L${round(x1)},${round(y1)} A${round(radius)},${round(radius)} 0 0,1 ${round(x2)},${round(y2)} Z`;
                    }
                }
                
                let background = `<rect width="${canvasWidth}" height="${canvasHeight}" fill="${solidColors[1]}" />`;
                let foregroundRays = '';
                
                if (gradientType === 'solid') {
                    for (let i = 0; i < rays; i += 2) {
                        foregroundRays += `<path d="${createRayPath(i)}" fill="${solidColors[0]}" />`;
                    }
                } else { 
                    for (let i = 0; i < rays; i += 2) {
                        foregroundRays += `<path d="${createRayPath(i)}" fill="url(#sunburstGradient)" />`;
                    }
                }
                innerContent = background + foregroundRays;
            }
           
            // Apply the clipping path to a group containing all visual elements
            svg.innerHTML = `<defs>${defs}</defs><g clip-path="url(#canvas-clip)">${innerContent}</g>`;
        }
        
        function requestDraw() { clearTimeout(debounceTimer); debounceTimer = setTimeout(drawSunburst, 16); }

        function renderRadialStops() {
            gradientStopsContainer.innerHTML = '';
            state.radialGradient.stops.forEach((stop, index) => {
                const item = document.createElement('div');
                item.className = 'gradient-stop-item flex items-center gap-3 p-2 bg-gray-700/50 rounded-md';
                item.innerHTML = `
                    <input type="color" class="stop-color" data-index="${index}" value="${stop.color}">
                    <div class="flex-1"><input type="range" class="stop-offset" data-index="${index}" min="0" max="100" value="${stop.offset}"></div>
                    <span class="text-xs w-12 text-center text-gray-400">${stop.offset}%</span>
                    <button class="remove-stop-btn text-gray-500 hover:text-red-400 transition-colors" data-index="${index}">
                        <svg class="w-5 h-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                    </button>`;
                gradientStopsContainer.appendChild(item);
            });
        }

        function updateUIFromState() {
            canvasWidthInput.value = state.canvasWidth;
            canvasHeightInput.value = state.canvasHeight;
            raysSlider.value = state.rays;
            centerXSlider.value = state.centerX;
            centerYSlider.value = state.centerY;
            gradientAngleSlider.value = state.gradientAngle;
            warpStrengthSlider.value = state.warpStrength;
            horizontalDistortionSlider.value = state.horizontalDistortion;
            verticalDistortionSlider.value = state.verticalDistortion;
            warpTypeSelect.value = state.warpType;
            raysValue.textContent = state.rays;
            centerXValue.textContent = `${state.centerX}%`;
            centerYValue.textContent = `${state.centerY}%`;
            gradientAngleValue.textContent = `${state.gradientAngle}Â°`;
            warpStrengthValue.textContent = `${state.warpStrength}%`;
            horizontalDistortionValue.textContent = `${state.horizontalDistortion}%`;
            verticalDistortionValue.textContent = `${state.verticalDistortion}%`;
            solidColor1Input.value = state.solidColors[0];
            solidColor2Input.value = state.solidColors[1];
            gradientColor1Input.value = state.gradientColors[0];
            gradientColor2Input.value = state.gradientColors[1];

            const isSolid = state.gradientType === 'solid', isLinear = state.gradientType === 'linear', isRadial = state.gradientType === 'radial';
            solidColorsContainer.style.display = isSolid ? 'flex' : 'none';
            linearGradientEditor.style.display = isLinear ? 'block' : 'none';
            radialGradientEditor.style.display = isRadial ? 'block' : 'none';
            if (isRadial) {
                renderRadialStops();
            }
            
            document.querySelectorAll('.gradient-btn').forEach(btn => {
                const isActive = btn.dataset.type === state.gradientType;
                btn.classList.toggle('bg-indigo-600', isActive); btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('bg-gray-700', !isActive); btn.classList.toggle('hover:bg-gray-600', !isActive);
            });

            const isWarpActive = state.warpType !== 'none';
            warpStrengthContainer.style.display = isWarpActive ? 'block' : 'none';
            twistDistortionContainer.classList.toggle('hidden', state.warpType !== 'twist');
            warpStrengthLabel.innerHTML = `Bend <span id="warp-strength-value" class="text-indigo-400 font-semibold">${state.warpStrength}%</span>`;
        }

        function setupEventListeners() {
            document.querySelectorAll('input[type="range"], input[type="number"], input[type="color"]').forEach(input => {
                if (input.closest('#radial-gradient-editor')) return;
                input.addEventListener('input', e => {
                    const { id, value } = e.target;
                    const valNum = parseFloat(value);
                    const valInt = parseInt(value);
                    switch (id) {
                        case 'rays': state.rays = valInt; raysValue.textContent = value; break;
                        case 'centerX': state.centerX = valNum; centerXValue.textContent = `${value}%`; break;
                        case 'centerY': state.centerY = valNum; centerYValue.textContent = `${value}%`; break;
                        case 'solid-color1': state.solidColors[0] = value; break;
                        case 'solid-color2': state.solidColors[1] = value; break;
                        case 'gradient-color1': state.gradientColors[0] = value; break;
                        case 'gradient-color2': state.gradientColors[1] = value; break;
                        case 'gradient-angle': state.gradientAngle = valInt; gradientAngleValue.textContent = `${value}Â°`; break;
                        case 'warp-strength': state.warpStrength = valNum; warpStrengthValue.textContent = `${value}%`; break;
                        case 'horizontal-distortion': state.horizontalDistortion = valNum; horizontalDistortionValue.textContent = `${value}%`; break;
                        case 'vertical-distortion': state.verticalDistortion = valNum; verticalDistortionValue.textContent = `${value}%`; break;
                        case 'canvas-width': state.canvasWidth = valInt || 1; svg.setAttribute('viewBox', `0 0 ${state.canvasWidth} ${state.canvasHeight}`); break;
                        case 'canvas-height': state.canvasHeight = valInt || 1; svg.setAttribute('viewBox', `0 0 ${state.canvasWidth} ${state.canvasHeight}`); break;
                    }
                    requestDraw();
                })
            });

            gradientTypeContainer.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') { state.gradientType = e.target.dataset.type; updateUIFromState(); requestDraw(); }
            });
            warpTypeSelect.addEventListener('change', e => { state.warpType = e.target.value; updateUIFromState(); requestDraw(); });
            
            // --- Radial Gradient Listeners ---
            addStopBtn.addEventListener('click', () => {
                state.radialGradient.stops.push({ color: '#ffffff', offset: 50});
                state.radialGradient.stops.sort((a, b) => a.offset - b.offset);
                renderRadialStops(); requestDraw();
            });
            gradientStopsContainer.addEventListener('input', e => {
                const index = e.target.dataset.index; if (!index) return;
                if (e.target.classList.contains('stop-color')) state.radialGradient.stops[index].color = e.target.value;
                if (e.target.classList.contains('stop-offset')) {
                    const offsetValue = parseInt(e.target.value); state.radialGradient.stops[index].offset = offsetValue;
                    e.target.closest('.gradient-stop-item').querySelector('span').textContent = `${offsetValue}%`;
                }
                requestDraw();
            });
            gradientStopsContainer.addEventListener('change', e => {
               if (e.target.classList.contains('stop-offset')) { state.radialGradient.stops.sort((a, b) => a.offset - b.offset); renderRadialStops(); }
            });
            gradientStopsContainer.addEventListener('click', e => {
                const removeBtn = e.target.closest('.remove-stop-btn');
                if (removeBtn && state.radialGradient.stops.length > 2) {
                    state.radialGradient.stops.splice(removeBtn.dataset.index, 1);
                    renderRadialStops(); requestDraw();
                }
            });

            // --- Action Buttons ---
            downloadBtn.addEventListener('click', downloadSVG);
            copyBtn.addEventListener('click', copySvgCode);
            randomizeBtn.addEventListener('click', randomize);
        }

        function downloadSVG() {
            // Create a temporary SVG element for export with explicit width and height attributes
            const svgExport = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svgExport.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            svgExport.setAttribute('width', state.canvasWidth);
            svgExport.setAttribute('height', state.canvasHeight);
            svgExport.setAttribute('viewBox', `0 0 ${state.canvasWidth} ${state.canvasHeight}`);
            svgExport.innerHTML = svg.innerHTML; // Copy the drawn content

            const svgData = new XMLSerializer().serializeToString(svgExport);
            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = 'sunburst.svg';
            document.body.appendChild(link); link.click();
            document.body.removeChild(link); URL.revokeObjectURL(url);
        }
        function copySvgCode() {
            const svgExport = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svgExport.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            svgExport.setAttribute('width', state.canvasWidth);
            svgExport.setAttribute('height', state.canvasHeight);
            svgExport.setAttribute('viewBox', `0 0 ${state.canvasWidth} ${state.canvasHeight}`);
            svgExport.innerHTML = svg.innerHTML;

            const svgData = new XMLSerializer().serializeToString(svgExport);
            const textArea = document.createElement("textarea");
            textArea.value = svgData;
            textArea.style.position = "fixed"; textArea.style.opacity = 0;
            document.body.appendChild(textArea); textArea.select();
            try {
                document.execCommand('copy');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg> Copied!`;
                setTimeout(() => { copyBtn.innerHTML = originalHTML; }, 2000);
            } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
            document.body.removeChild(textArea);
        }
        function randomize() {
            const getRnd = (min, max) => Math.random() * (max - min) + min;
            const getRndInt = (min, max) => Math.floor(getRnd(min, max + 1));
            const getRndColor = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            state.rays = getRndInt(1, 50) * 2;
            state.centerX = getRndInt(25, 75); state.centerY = getRndInt(25, 75);
            state.solidColors = [getRndColor(), getRndColor()];
            state.gradientColors = [getRndColor(), getRndColor()];
            state.gradientType = ['solid', 'linear', 'radial'][getRndInt(0, 2)];
            state.gradientAngle = getRndInt(0, 360);
            if (state.gradientType === 'radial') {
                const stopCount = getRndInt(2, 5); state.radialGradient.stops = [];
                for (let i = 0; i < stopCount; i++) state.radialGradient.stops.push({ color: getRndColor(), offset: Math.round((i / (stopCount - 1)) * 100) });
                state.radialGradient.stops.sort((a,b) => a.offset - b.offset);
            }
            state.warpType = ['none', 'twist'][getRndInt(0, 1)];
            if (state.warpType === 'twist' && state.rays > 0) {
                state.warpStrength = getRndInt(-100, 100);
                state.horizontalDistortion = getRndInt(-50, 50); state.verticalDistortion = getRndInt(-50, 50);
            } else { state.warpType = 'none'; state.warpStrength = 0; state.horizontalDistortion = 0; state.verticalDistortion = 0; }
            updateUIFromState(); requestDraw();
        }
        
        function init() {
            svg.setAttribute('viewBox', `0 0 ${state.canvasWidth} ${state.canvasHeight}`);
            updateUIFromState();
            setupEventListeners();
            requestDraw();
        }
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

